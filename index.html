<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì œì´ì”¨ì˜ ì•¼êµ¬ê²Œì„</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import confetti from "https://cdn.skypack.dev/canvas-confetti";

    const firebaseConfig = {
      apiKey: "AIzaSyAx_NzeYy6VU_IMPtrJ9NCNKzwYlCKUDHE",
      authDomain: "bball-game-9936c.firebaseapp.com",
      projectId: "bball-game-9936c",
      storageBucket: "bball-game-9936c.appspot.com",
      messagingSenderId: "1096857454514",
      appId: "1:1096857454514:web:8f18f4d65a1a918c32c6ab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentInput = '';
    let answer = '';
    let turns = 0;
    const maxTurns = 10;
    let playerName = '';
    let startTime = 0;
    let timerInterval;

    const inputDisplay = document.getElementById('input-display');
    const keypad = document.getElementById('keypad');
    const resultLog = document.getElementById('result-log');
    const gameInfo = document.getElementById('game-info');
    const timerDisplay = document.getElementById('timer');
    const answerBtn = document.getElementById('reveal-answer');
    const startScreen = document.getElementById('start-screen');
    const nicknameInput = document.getElementById('nickname-input');
    const rankingBoard = document.getElementById('ranking-board');

    async function generateAnswer() {
      const digits = [];
      while (digits.length < 3) {
        const n = Math.floor(Math.random() * 10);
        if (!digits.includes(n)) digits.push(n);
      }
      return digits.join('');
    }

    async function saveAnswer(answer) {
      await setDoc(doc(db, 'games', 'currentGame'), {
        answer,
        createdAt: new Date(),
        turns: 0
      });
    }

    async function loadAnswer() {
      const docSnap = await getDoc(doc(db, 'games', 'currentGame'));
      if (docSnap.exists()) {
        return docSnap.data();
      } else {
        const newAnswer = await generateAnswer();
        await saveAnswer(newAnswer);
        return { answer: newAnswer, turns: 0 };
      }
    }

    function updateInputDisplay() {
      inputDisplay.innerText = currentInput.padEnd(3, '_').split('').join(' ');
    }

    function addGuessResult(guess, result) {
      const entry = document.createElement('div');
      entry.className = 'guess-entry';
      entry.innerText = `ğŸ”¢ ${guess} â†’ ${result}`;
      resultLog.prepend(entry);
    }

    function checkGuess(guess, answer) {
      let result = '';
      for (let i = 0; i < 3; i++) {
        if (guess[i] === answer[i]) {
          result += 'âš«'; // strike
        } else if (answer.includes(guess[i])) {
          result += 'âšª'; // ball
        } else {
          result += 'âŒ'; // out
        }
      }
      return result;
    }

    function startTimer() {
      timerInterval = setInterval(() => {
        const seconds = Math.floor((Date.now() - startTime) / 1000);
        timerDisplay.innerText = `â±ï¸ ${seconds}ì´ˆ ê²½ê³¼ ì¤‘...`;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
    }

    async function renderRanking() {
      const docSnap = await getDoc(doc(db, 'games', 'currentGame'));
      const history = docSnap.data().history || [];
      if (history.length === 0) {
        rankingBoard.innerHTML = '<h3>ğŸ† ë­í‚¹ ë³´ë“œ</h3><div>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      const sorted = [...history].sort((a, b) => a.turns - b.turns || a.seconds - b.seconds);
      rankingBoard.innerHTML = '<h3>ğŸ† ë­í‚¹ ë³´ë“œ</h3>';
      sorted.forEach((entry, i) => {
        const div = document.createElement('div');
        div.innerText = `${i + 1}. ${entry.player} - ${entry.turns}í„´ / ${entry.seconds}ì´ˆ`;
        rankingBoard.appendChild(div);
      });
    }

    async function handleConfirm() {
      if (currentInput.length !== 3 || turns >= maxTurns) return;
      const result = checkGuess(currentInput, answer);
      addGuessResult(currentInput, result);
      turns++;
      if (turns >= maxTurns && result !== 'âš«âš«âš«') {
        gameInfo.innerText = `ğŸ˜¢ í„´ ì¢…ë£Œ! ì •ë‹µì€ ${answer}`;
        stopTimer();
      } else if (result === 'âš«âš«âš«') {
        const seconds = Math.floor((Date.now() - startTime) / 1000);
        stopTimer();
        gameInfo.innerText = `ğŸ‰ í™ˆëŸ°! ${playerName}ë‹˜ ì¶•í•˜í•´ìš”! (${turns}í„´ / ${seconds}ì´ˆ)`;
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        await updateDoc(doc(db, 'games', 'currentGame'), {
          history: arrayUnion({ player: playerName, turns, seconds })
        });
        renderRanking();
      } else {
        gameInfo.innerText = `í„´: ${turns}/${maxTurns}`;
      }
      if (turns >= 9) {
        answerBtn.style.display = 'inline-block';
      }
      currentInput = '';
      updateInputDisplay();
    }

    function createKeypad() {
      keypad.innerHTML = '';
      for (let i = 1; i <= 9; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.onclick = () => {
          if (!currentInput.includes(i.toString()) && currentInput.length < 3) {
            currentInput += i.toString();
            updateInputDisplay();
          }
        };
        keypad.appendChild(btn);
      }
      const zeroBtn = document.createElement('button');
      zeroBtn.innerText = '0';
      zeroBtn.onclick = () => {
        if (!currentInput.includes('0') && currentInput.length < 3) {
          currentInput += '0';
          updateInputDisplay();
        }
      };
      keypad.appendChild(zeroBtn);

      const delBtn = document.createElement('button');
      delBtn.innerText = 'â†';
      delBtn.onclick = () => {
        currentInput = currentInput.slice(0, -1);
        updateInputDisplay();
      };
      keypad.appendChild(delBtn);

      const okBtn = document.createElement('button');
      okBtn.innerText = 'í™•ì¸';
      okBtn.onclick = handleConfirm;
      okBtn.id = 'confirm-btn';
      keypad.appendChild(okBtn);
    }

    answerBtn.onclick = () => {
      alert(`ì •ë‹µì€ ${answer} ì…ë‹ˆë‹¤! ğŸ¤«`);
    };

    document.getElementById('start-button').onclick = async () => {
      const name = nicknameInput.value.trim();
      if (!name) return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
      playerName = name;
      startTime = Date.now();
      startTimer();
      startScreen.style.display = 'none';
      const gameData = await loadAnswer();
      answer = gameData.answer;
      turns = 0;
      gameInfo.innerText = `ê²Œì„ ì‹œì‘! í„´: ${turns}/${maxTurns}`;
      updateInputDisplay();
      createKeypad();
    };

    window.onload = () => {
      renderRanking();
    };
  </script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #e0f7fa;
      padding: 20px;
      text-align: center;
    }
    #start-screen input {
      padding: 10px;
      font-size: 1rem;
    }
    #start-screen button {
      padding: 10px 20px;
      font-size: 1rem;
      margin-left: 10px;
    }
    .keypad button {
      width: 60px;
      height: 60px;
      font-size: 1.5rem;
      margin: 5px;
      border-radius: 10px;
      background-color: #ffd54f;
      border: none;
    }
    #game-guide {
      margin-bottom: 15px;
      background: #fff3cd;
      padding: 10px;
      border-radius: 10px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h1>ğŸŒ¿ ì œì´ì”¨ì˜ ì•¼êµ¬ê²Œì„</h1>
  <div id="game-guide">
    <strong>ê²Œì„ ê°€ì´ë“œë¼ì¸ ğŸ®</strong><br/>
    - ì„œë¡œ ë‹¤ë¥¸ ì„¸ ìë¦¬ ìˆ«ìë¥¼ ë§ì¶”ëŠ” ê²Œì„ì´ì—ìš”!<br/>
    - ìˆ«ìë§Œ ë§ê³  ìë¦¬ê°€ ë‹¤ë¥´ë©´ âšª ë³¼<br/>
    - ìˆ«ìì™€ ìë¦¬ê¹Œì§€ ë§ìœ¼ë©´ âš« ìŠ¤íŠ¸ë¼ì´í¬<br/>
    - ìˆ«ìê°€ í‹€ë¦¬ë©´ âŒ<br/>
    <br/>
    ì´ 10í„´ ì•ˆì— í™ˆëŸ°ì„ ë…¸ë ¤ë³´ì„¸ìš”! âš¾
  </div>
  <div id="start-screen">
    <input id="nickname-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" />
    <button id="start-button">ê²Œì„ ì‹œì‘</button>
  </div>
  <div id="game-info"></div>
  <div id="timer"></div>
  <div id="input-display">_ _ _</div>
  <div class="keypad" id="keypad"></div>
  <button id="reveal-answer" style="display: none">ì •ë‹µ ë³´ê¸°</button>
  <div id="result-log"></div>
  <div id="ranking-board"></div>
</body>
</html>

